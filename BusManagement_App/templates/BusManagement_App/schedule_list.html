{% extends 'BusManagement_App/Base.html' %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4">Liste des Horaires</h2>
  <a href="{% url 'add_schedule' %}" class="btn btn-success mb-3">Ajouter un nouvel horaire</a>

  <!-- Container for HERE Maps -->
  <div id="map" style="height: 400px; margin-bottom: 20px;"></div>

  <div class="card">
    <div class="card-body">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Horaires</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for schedule in object_list %}
            <tr>
              <td>{{ schedule.id }}</td>
              <td>{{ schedule }}</td>
              <td>
                <a href="{% url 'update_schedule' schedule.pk %}" class="btn btn-primary btn-sm">Modifier</a>
                <a href="{% url 'delete_schedule' schedule.pk %}" class="btn btn-danger btn-sm">Supprimer</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  var H; // Define 'H' in the global scope

  // Load the HERE Maps API script
  function loadHereMapsScript() {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://js.api.here.com/v3/3.1/mapsjs.bundle.js';
      script.async = true;
      script.onload = () => {
        H = window.H; // Assign 'H' after the script is loaded
        resolve();
      };
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  async function initMap() {
    try {
      // Wait for the HERE Maps API script to load
      await loadHereMapsScript();

      // Initialize HERE Map
      const platform = new H.service.Platform({
        'apikey': 'B7KodafHmHQFQna3MlbTC6Z4BxLx7CfKKsa5EbZLHbk' // Replace with your actual API key
      });

      // Obtain the default map types from the platform object:
      const defaultLayers = platform.createDefaultLayers();

      // Create a map instance:
      const map = new H.Map(document.getElementById("map"), defaultLayers.vector.normal.map, {
        center: { lat: -34.397, lng: 150.644 },
        zoom: 8,
      });

      // Add a resize listener to make sure that the map occupies the whole container
      window.addEventListener('resize', () => map.getViewPort().resize());

    } catch (error) {
      console.error('Error loading HERE Maps API:', error);
    }
  }

  // Initialize the map after defining 'initMap'
  window.onload = initMap;
</script>

{% endblock %}
