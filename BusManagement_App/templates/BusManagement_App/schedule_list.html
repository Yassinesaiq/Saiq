{% extends 'BusManagement_App/Base.html' %}

{% block content %}
<style>
  #myMap {
    height: 400px;
    margin-bottom: 20px;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  @media (max-width: 768px) {
    #myMap {
      height: 300px;
    }
  }
</style>

<div class="container mt-5">
  <h2 class="mb-4">Liste des Horaires</h2>
  <a href="{% url 'add_schedule' %}" class="btn btn-success mb-3">Ajouter un nouvel horaire</a>

  <!-- Container for Azure Maps -->
  <div id="myMap" style="height: 400px; margin-bottom: 20px;"></div>

  <div class="card">
    <div class="card-body">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Horaires</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for schedule in object_list %}
            <tr>
              <td>{{ schedule.id }}</td>
              <td>{{ schedule }}</td>
              <td>
                <a href="{% url 'update_schedule' schedule.pk %}" class="btn btn-primary btn-sm">Modifier</a>
                <a href="{% url 'delete_schedule' schedule.pk %}" class="btn btn-danger btn-sm">Supprimer</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // Utilisez cette variable pour stocker votre clé d'API de manière sécurisée
  const azureMapsKey = "{{ azure_maps_key }}";
</script>

<script>
  var map;
  var datasource;

  function GetMap() {
      map = new atlas.Map('myMap', {
        center: [-5.0033, 34.0345],
        zoom: 10,
        authOptions: {
            authType: 'subscriptionKey',
            subscriptionKey: 'fo42NIlUsCF72sSrXlAIFCukuuqZ5fN7OQgg52JLPlA'
        }
      });

      // Initialize the data source
      datasource = new atlas.source.DataSource();

      // Add a layer for rendering point data.
      var resultLayer = new atlas.layer.SymbolLayer(datasource, null, {
          iconOptions: {
              image: 'pin-round-darkblue',
              anchor: 'center',
              allowOverlap: true
          },
          textOptions: {
              anchor: "top"
          }
      });

      map.layers.add(resultLayer);

      // Call the search service
      var query = 'gasoline-station';
      var radius = 9000;
      var lat = -5.0033;
      var lon = 34.0345;
      var url = `https://atlas.microsoft.com/search/poi/json?api-version=1.0&query=${query}&lat=${lat}&lon=${lon}&radius=${radius}`;

      fetch(url, {
          headers: {
              "Subscription-Key": map.authentication.getToken()
          }
      })
      .then((response) => response.json())
      .then((response) => {
          var bounds = [];

          //Extract GeoJSON feature collection from the response and add it to the datasource
          var data = response.results.map((result) => {
              var position = [result.position.lon, result.position.lat];
              bounds.push(position);
              return new atlas.data.Feature(new atlas.data.Point(position), { ...result });
          });
          datasource.add(data);

          //Set camera to bounds to show the results
          map.setCamera({
              bounds: new atlas.data.BoundingBox.fromLatLngs(bounds),
              zoom: 10,
              padding: 15
          });
      });
      map.events.add("ready", function() {
        // Add Traffic Flow to the Map
        map.setTraffic({
            flow: "relative"
        });
       //Create a data source and add it to the map.
datasource = new atlas.source.DataSource();
map.sources.add(datasource);

//Add a layer for rendering the route lines and have it render under the map labels.
map.layers.add(new atlas.layer.LineLayer(datasource, null, {
    strokeColor: ['get', 'strokeColor'],
    strokeWidth: ['get', 'strokeWidth'],
    lineJoin: 'round',
    lineCap: 'round'
}), 'labels');

//Add a layer for rendering point data.
map.layers.add(new atlas.layer.SymbolLayer(datasource, null, {
    iconOptions: {
        image: ['get', 'icon'],
        allowOverlap: true
    },
    textOptions: {
        textField: ['get', 'title'],
        offset: [0, 1.2]
    },
    filter: ['any', ['==', ['geometry-type'], 'Point'], ['==', ['geometry-type'], 'MultiPoint']] //Only render Point or MultiPoints in this layer.
})); 
    });
  //Create the GeoJSON objects which represent the start and end point of the route.
var startPoint = new atlas.data.Feature(new atlas.data.Point([-122.356099, 47.580045]), {
  title: 'Ecole NAjah, Inc.',
  icon: 'pin-blue'
});

var endPoint = new atlas.data.Feature(new atlas.data.Point([-122.201164, 47.616940]), {
  title: 'Microsoft - Lincoln Square',
  icon: 'pin-round-blue'
});

//Add the data to the data source.
datasource.add([startPoint, endPoint]);

//Fit the map window to the bounding box defined by the start and end positions.
map.setCamera({
  bounds: atlas.data.BoundingBox.fromData([startPoint, endPoint]),
  padding: 100
});  
  }
</script>

<script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js" async defer></script>
<script src="https://atlas.microsoft.com/sdk/javascript/service/2/atlas-service.min.js" async defer></script>
<script>
  window.onload = function() {
    GetMap();
  };
</script>

{% endblock %}
