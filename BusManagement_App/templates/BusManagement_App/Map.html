{% extends 'BusManagement_App/Base.html' %}

{% block extra_js %}
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js" async defer></script>
    <script src="https://atlas.microsoft.com/sdk/javascript/service/2/atlas-service.min.js" async defer></script>
    <script src="https://atlas.microsoft.com/sdk/javascript/service/2/atlas-service.min.js" async defer></script>

    <script>
        var map;
        var datasource;
        var geojson;
        var secondaryAddresses = {{ second_addresses|safe }};
        var universityCoords;

        function GetMap() {
            map = new atlas.Map('myMap', {
                center: [-5.0033, 34.0345],
                zoom: 10,
                authOptions: {
                    authType: 'subscriptionKey',
                    subscriptionKey: 'tX8QollQ26xGAEAJ6w3YSI3mHjr65fNRkPAgrgn84Q4'
                }
            });

            map.events.add('ready', function() {
                datasource = new atlas.source.DataSource();
                map.sources.add(datasource);

                geojson = {{ geojson_data|safe }};
                datasource.add(geojson);

                universityCoords = [-4.9800265037012945, 34.03450501818707];

                var universityFeature = {
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": universityCoords
                    },
                    "properties": {
                        "name": "Université Sidi Mohammed ben Abdellah"
                    }
                };
                datasource.add(universityFeature);

                var resultLayer = new atlas.layer.SymbolLayer(datasource, null, {
                    iconOptions: {
                        image: 'pin-round-darkblue',
                        anchor: 'center',
                        allowOverlap: true
                    },
                    textOptions: {
                        textField: ['coalesce', ['get', 'student_name'], ['get', 'name']],
                        offset: [0, -3],
                        anchor: "top",
                        color: 'black',
                        size: 13
                    }
                });

                map.layers.add(resultLayer);

                var popup = new atlas.Popup({
                    pixelOffset: [0, -20],
                    closeButton: false
                });

                map.events.add('mouseover', resultLayer, function(e) {
                    if (e.shapes && e.shapes.length > 0) {
                        if (e.shapes[0].geometry && e.shapes[0].geometry.coordinates) {
                            var properties = e.shapes[0].getProperties();
                            popup.setOptions({
                                content: properties.name,
                                position: e.shapes[0].geometry.coordinates
                            });
                            popup.open(map);
                        }
                    }
                });

                map.events.add('mouseout', resultLayer, function(e) {
                    popup.close();
                });

                // Vérifiez que le SearchControl est bien chargé
                if (atlas.control && atlas.control.SearchControl) {
                    var searchControl = new atlas.control.SearchControl({
                        language: 'fr-FR',
                        placeholder: 'Rechercher une adresse...',
                        showMarker: true,
                        showPopup: true
                    });
                    map.controls.add(searchControl, {
                        position: 'top-right'
                    });
                } else {
                    console.error('SearchControl is not available.');
                }

                //Add a layer for rendering the route lines and have it render under the map labels.
                map.layers.add(new atlas.layer.LineLayer(datasource, null, {
                    strokeColor: '#2272B9',
                    strokeWidth: 5,
                    lineJoin: 'round',
                    lineCap: 'round'
                }), 'labels');

                //Add a layer for rendering point data.
                map.layers.add(new atlas.layer.SymbolLayer(datasource, null, {
                    iconOptions: {
                        image: ['get', 'icon'],
                        allowOverlap: true
                },
                    textOptions: {
                        textField: ['get', 'title'],
                        offset: [0, 1.2]
                    },
                    filter: ['any', ['==', ['geometry-type'], 'Point'], ['==', ['geometry-type'], 'MultiPoint']] //Only render Point or MultiPoints in this layer.
                }));

                let locations = [];

                console.log(locations);

                geojson["features"].forEach((location) => {
                    if (isArraySubset(locations, location["geometry"]["coordinates"])) {
                        return;
                    }

                    locations.push(location["geometry"]["coordinates"]);
                });


                if (locations.length > 1) {
                    let busRoute = [universityCoords, ...findShortestRoute(locations, universityCoords), universityCoords];
    
                    console.log(busRoute);
    
                    let pointA = busRoute[0];
                    let pointB = busRoute[1];
    
                    for (let i=1; i < busRoute.length - 1; i++) {
                        if (isPathTooFar(pointA, pointB, 100)) {
                            pointB = busRoute[i + 1]
                            continue;
                        }
    
                        buildPath(pointA, pointB, `Point ${i}`, `Point ${i + 1}`);
    
                        pointA = pointB;
                        pointB = busRoute[i + 1]
                    }
                } else {
                    buildPath(universityCoords, locations[0], "University", "Student");
                    buildPath(locations[0], universityCoords, "Student", "University");
                }
            });
        }

        function isPathTooFar(pointA, pointB, limit) {
            if (calculateDistance(pointA, pointB) > limit) {
                return true;
            }

            return false;
        }

        function isArraySubset(parentArray, targetArray) {
            // Check if the length of the target array is greater than the parent array
            if (targetArray.length > parentArray.length) return false;

            // Use some() to iterate over the parent array
            return parentArray.some(subArray => 
                // Use every() to ensure all elements of the target array exist in the current sub-array
                targetArray.every(element => subArray.includes(element))
            );
        }

        function permute(array) {
            const result = [];
            if (array.length === 1) {
                return array.map(item => [item]);
            }

            array.forEach((value, index) => {
                const rest = array.slice(0, index).concat(array.slice(index + 1));
                const forRest = permute(rest);
                forRest.forEach(permutation => {
                    result.push([value].concat(permutation));
                });
            });

            return result;
        }

        function fetchDirections(startPoint, endPoint) {
            var query = startPoint.geometry.coordinates[1] + "," +
                        startPoint.geometry.coordinates[0] + ":" +
                        endPoint.geometry.coordinates[1] + "," +
                        endPoint.geometry.coordinates[0];

            var url = `https://atlas.microsoft.com/route/directions/json?api-version=1.0&query=${query}`;

            //Make a search route request
            fetch(url, {
                headers: {
                    "Subscription-Key": map.authentication.getToken()
                }
            })
            .then((response) => response.json())
            .then((response) => {
                var route = response.routes[0];
                //Create an array to store the coordinates of each turn
                var routeCoordinates = [];
                route.legs.forEach((leg) => {
                    var legCoordinates = leg.points.map((point) => {
                        return [point.longitude, point.latitude];
                    });
                    //Add each turn to the array
                    routeCoordinates = routeCoordinates.concat(legCoordinates);
                });
                //Add route line to the datasource
                datasource.add(new atlas.data.Feature(new atlas.data.LineString(routeCoordinates)));
            });
        }

        function buildPath(startCoords, targetCoords, startPointTitle, targetPointTitle) {
            //Create the GeoJSON objects which represent the start and end points of the route.
            var startPoint = new atlas.data.Feature(new atlas.data.Point(startCoords), {
                title: startPointTitle,
                icon: "pin-blue"
            });

            var endPoint = new atlas.data.Feature(new atlas.data.Point(targetCoords), {
                title: targetPointTitle,
                icon: "pin-round-blue"
            });

            //Add the data to the data source.
            datasource.add([startPoint, endPoint]);

            fetchDirections(startPoint, endPoint);

            // map.setCamera({
            //     bounds: atlas.data.BoundingBox.fromData([startPoint, endPoint]),
            //     padding: 80
            // });
        }

        function calculateDistance(pointA, pointB) {
            // Calculate the Euclidean distance between two points
            const lat1 = Math.PI * (pointA[0] / 180);
            const lon1 = Math.PI * (pointA[1] / 180);
            const lat2 = Math.PI * (pointB[0] / 180);
            const lon2 = Math.PI * (pointB[1] / 180);

            const dLat = lat2 - lat1;
            const dLon = lon2 - lon1;

            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1) * Math.cos(lat2) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return 6371 * c; // Radius of earth in km. Use 3956 if you want miles
        }

        function generateRoutes(locations) {
            let routes = [universityCoords];
            let startIndex = 0;

            const remainingLocations = locations.slice(startIndex + 1); // Exclude the starting point and itself
            const combinations = permute(remainingLocations); // Generate all permutations of the remaining locations

            // Add the starting point back to each combination
            combinations.forEach(combination => {
                const route = [locations[startIndex]].concat(combination);
                routes.push(route);
            });

            return routes;
        }

        function findShortestRoute(locations, startingPoint) {
            const allRoutes = generateRoutes(locations);
            let minDistance = Infinity;
            let shortestRoute = [];

            allRoutes.forEach(route => {
                let distance = 0;
                for (let i = 0; i < route.length - 1; i++) {
                    distance += calculateDistance(route[i], route[i + 1]);
                }
                distance += calculateDistance(route[route.length - 1], startingPoint); // Return to the starting point

                if (distance < minDistance) {
                    minDistance = distance;
                    shortestRoute = route;
                }
            });

            return shortestRoute;
        }

        window.onload = function() {
            GetMap();
        };
    </script>
{% endblock %}

{% block content %}
    <style>
        #myMap {
            height: 400px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            #myMap {
                height: 300px;
            }
        }
    </style>

    <div id="myMap"></div>
{% endblock %}
